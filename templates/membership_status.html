<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Membership Application Status - Community Hub</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f5f5;
            padding: 20px;
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background-color: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
        }
        
        h1 {
            text-align: center;
            margin-bottom: 30px;
            color: #2c3e50;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
        }
        
        .status-section {
            margin-bottom: 30px;
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #3498db;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #34495e;
        }
        
        input[type="text"] {
            width: 100%;
            max-width: 400px;
            padding: 12px;
            border: 1px solid #bdc3c7;
            border-radius: 4px;
            font-size: 16px;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
            font-size: 16px;
            transition: background-color 0.3s;
        }
        
        .btn-primary {
            background-color: #3498db;
            color: white;
        }
        
        .btn-primary:hover {
            background-color: #2980b9;
        }
        
        .btn-back {
            background-color: #95a5a6;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
            margin-bottom: 20px;
        }
        
        .btn-back:hover {
            background-color: #7f8c8d;
        }
        
        .status-result {
            margin-top: 20px;
            padding: 20px;
            border-radius: 6px;
            display: none;
        }
        
        .status-pending {
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
        }
        
        .status-approved {
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        
        .status-rejected {
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        
        .status-cancelled {
            background-color: #e2e3e5;
            border: 1px solid #d6d8db;
            color: #383d41;
        }
        
        .applications-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        .applications-table th,
        .applications-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        
        .applications-table th {
            background-color: #f8f9fa;
            font-weight: 600;
        }
        
        .status-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .badge-pending {
            background-color: #fff3cd;
            color: #856404;
        }
        
        .badge-approved {
            background-color: #d4edda;
            color: #155724;
        }
        
        .badge-rejected {
            background-color: #f8d7da;
            color: #721c24;
        }
        
        .badge-cancelled {
            background-color: #e2e3e5;
            color: #383d41;
        }
        
        .action-buttons {
            display: flex;
            gap: 5px;
        }
        
        .btn-sm {
            padding: 6px 12px;
            font-size: 12px;
        }
        
        .btn-success {
            background-color: #28a745;
            color: white;
        }
        
        .btn-danger {
            background-color: #dc3545;
            color: white;
        }
        
        .btn-warning {
            background-color: #ffc107;
            color: #212529;
        }
    </style>
</head>
<body>
    <div class="container">
        <a href="/" class="btn-back">‚Üê Back to Home</a>
        <h1>Membership Application Status</h1>
        
        <div class="status-section">
            <h2>Check Your Application Status</h2>
            <div class="form-group">
                <label for="mykad-number">Enter Your MyKad Number</label>
                <input type="text" id="mykad-number" placeholder="e.g., 901231145678">
            </div>
            <button class="btn btn-primary" id="check-status">Check Status</button>
            
            <div id="status-result" class="status-result">
                <!-- Status will be displayed here -->
            </div>
        </div>

        <div class="status-section">
            <h2>All Applications</h2>
            <div id="applications-list">
                <div class="loading">Loading applications...</div>
            </div>
        </div>
    </div>

    <script>
        document.getElementById('check-status').addEventListener('click', function() {
            const mykadNumber = document.getElementById('mykad-number').value.trim();
            
            if (!mykadNumber) {
                alert('Please enter your MyKad number');
                return;
            }
            
            fetch('/api/membership/check-status', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    mykad_no: mykadNumber
                })
            })
            .then(response => response.json())
            .then(data => {
                const statusResult = document.getElementById('status-result');
                
                if (data.success) {
                    const application = data.application;
                    const statusClass = `status-${application.status.toLowerCase()}`;
                    
                    statusResult.innerHTML = `
                        <div class="${statusClass}">
                            <h3>Application Found</h3>
                            <p><strong>Name:</strong> ${application.full_name}</p>
                            <p><strong>MyKad:</strong> ${application.mykad_no}</p>
                            <p><strong>Membership Type:</strong> ${application.membership_type}</p>
                            <p><strong>Applied On:</strong> ${new Date(application.submitted_at).toLocaleDateString()}</p>
                            <p><strong>Status:</strong> <span class="status-badge badge-${application.status.toLowerCase()}">${application.status}</span></p>
                            ${application.status === 'Pending' ? '<p>Your application is under review. Please check back later.</p>' : ''}
                            ${application.status === 'Approved' ? '<p>Congratulations! Your application has been approved.</p>' : ''}
                            ${application.status === 'Rejected' ? '<p>Your application has been rejected. Please contact support for more information.</p>' : ''}
                            ${application.status === 'Cancelled' ? '<p>Your application has been cancelled.</p>' : ''}
                        </div>
                    `;
                    statusResult.style.display = 'block';
                } else {
                    statusResult.innerHTML = `
                        <div class="status-rejected">
                            <h3>Application Not Found</h3>
                            <p>${data.message}</p>
                            <p>Please check your MyKad number or submit a new application.</p>
                        </div>
                    `;
                    statusResult.style.display = 'block';
                }
            })
            .catch(error => {
                console.error('Error:', error);
                const statusResult = document.getElementById('status-result');
                statusResult.innerHTML = `
                    <div class="status-rejected">
                        <h3>Error</h3>
                        <p>An error occurred while checking your application status. Please try again.</p>
                    </div>
                `;
                statusResult.style.display = 'block';
            });
        });

        // Load all applications
        function loadApplications() {
            fetch('/api/membership/applications')
                .then(response => response.json())
                .then(data => {
                    const applicationsList = document.getElementById('applications-list');
                    
                    if (data.success && data.applications.length > 0) {
                        let html = `
                            <table class="applications-table">
                                <thead>
                                    <tr>
                                        <th>Name</th>
                                        <th>MyKad</th>
                                        <th>Membership Type</th>
                                        <th>Applied Date</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                        `;
                        
                        data.applications.forEach(app => {
                            html += `
                                <tr>
                                    <td>${app.full_name}</td>
                                    <td>${app.mykad_no}</td>
                                    <td>${app.membership_type}</td>
                                    <td>${new Date(app.submitted_at).toLocaleDateString()}</td>
                                    <td><span class="status-badge badge-${app.status.toLowerCase()}">${app.status}</span></td>
                                    <td class="action-buttons">
                                        ${app.status === 'Pending' ? `
                                            <button class="btn btn-success btn-sm" onclick="updateStatus(${app.id}, 'Approved')">Approve</button>
                                            <button class="btn btn-danger btn-sm" onclick="updateStatus(${app.id}, 'Rejected')">Reject</button>
                                        ` : ''}
                                        ${app.status === 'Approved' ? `
                                            <button class="btn btn-warning btn-sm" onclick="updateStatus(${app.id}, 'Cancelled')">Cancel</button>
                                        ` : ''}
                                        ${app.status === 'Rejected' ? `
                                            <button class="btn btn-success btn-sm" onclick="updateStatus(${app.id}, 'Approved')">Approve</button>
                                        ` : ''}
                                    </td>
                                </tr>
                            `;
                        });
                        
                        html += `</tbody></table>`;
                        applicationsList.innerHTML = html;
                    } else {
                        applicationsList.innerHTML = '<p>No applications found.</p>';
                    }
                })
                .catch(error => {
                    console.error('Error loading applications:', error);
                    document.getElementById('applications-list').innerHTML = '<p>Error loading applications.</p>';
                });
        }

        function updateStatus(applicationId, newStatus) {
            if (!confirm(`Are you sure you want to ${newStatus.toLowerCase()} this application?`)) {
                return;
            }
            
            fetch('/api/membership/update-status', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    application_id: applicationId,
                    status: newStatus
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(data.message);
                    loadApplications(); // Reload the applications list
                    
                    // Also update the status result if it's showing the same application
                    const currentMykad = document.getElementById('mykad-number').value;
                    if (currentMykad) {
                        document.getElementById('check-status').click();
                    }
                } else {
                    alert('Error: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred while updating the status.');
            });
        }

        // Load applications when page loads
        loadApplications();
    </script>
</body>
</html>